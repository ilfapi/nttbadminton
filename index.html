<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Gi·∫£i ƒê·∫•u C·∫ßu L√¥ng</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                color: #333;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }

            .header {
                background: rgba(255, 255, 255, 0.95);
                padding: 20px;
                border-radius: 15px;
                margin-bottom: 20px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }

            .header h1 {
                text-align: center;
                color: #2c3e50;
                margin-bottom: 10px;
                font-size: 2.5em;
                background: linear-gradient(45deg, #667eea, #764ba2);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }

            .auth-section {
                display: flex;
                justify-content: center;
                gap: 10px;
                margin-bottom: 20px;
            }

            .btn {
                padding: 12px 24px;
                border: none;
                border-radius: 25px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s ease;
                text-transform: uppercase;
                letter-spacing: 1px;
            }

            .btn-primary {
                background: linear-gradient(45deg, #667eea, #764ba2);
                color: white;
            }

            .btn-secondary {
                background: linear-gradient(45deg, #36d1dc, #5b86e5);
                color: white;
            }

            .btn-danger {
                background: linear-gradient(45deg, #ff6b6b, #ee5a52);
                color: white;
            }

            .btn-success {
                background: linear-gradient(45deg, #51cf66, #40c057);
                color: white;
            }

            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            }

            .card {
                background: rgba(255, 255, 255, 0.95);
                padding: 25px;
                border-radius: 15px;
                margin-bottom: 20px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                transition: transform 0.3s ease;
            }

            .card:hover {
                /* transform: translateY(-5px); */
            }

            .form-group {
                margin-bottom: 20px;
            }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                font-weight: 600;
                color: #2c3e50;
            }

            .form-group input,
            .form-group select {
                width: 100%;
                padding: 12px;
                border: 2px solid #e0e6ed;
                border-radius: 10px;
                font-size: 16px;
                transition: border-color 0.3s ease;
                background: rgba(255, 255, 255, 0.9);
            }

            .form-group input:focus,
            .form-group select:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

            .grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
            }

            .player-card {
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 20px;
                border-radius: 15px;
                text-align: center;
                transition: transform 0.3s ease;
            }

            .player-card:hover {
                transform: scale(1.05);
            }

            .match-card {
                background: linear-gradient(135deg, #36d1dc, #5b86e5);
                color: white;
                padding: 20px;
                border-radius: 15px;
                margin-bottom: 15px;
            }

            .level-badge {
                padding: 5px 15px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: bold;
                display: inline-block;
                margin: 5px;
            }

            .level-1 {
                background: #51cf66;
                color: white;
            }
            .level-2 {
                background: #ffd43b;
                color: #333;
            }
            .level-3 {
                background: #ff6b6b;
                color: white;
            }

            .hidden {
                display: none;
            }

            .nav-tabs {
                display: flex;
                background: rgba(255, 255, 255, 0.9);
                border-radius: 10px;
                padding: 5px;
                margin-bottom: 20px;
            }

            .nav-tab {
                flex: 1;
                padding: 12px;
                text-align: center;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s ease;
                font-weight: 600;
            }

            .nav-tab.active {
                background: linear-gradient(45deg, #667eea, #764ba2);
                color: white;
            }

            .ranking-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }

            .ranking-table th,
            .ranking-table td {
                padding: 15px;
                text-align: left;
                border-bottom: 2px solid #e0e6ed;
            }

            .ranking-table th {
                background: linear-gradient(45deg, #667eea, #764ba2);
                color: white;
                font-weight: 600;
            }

            .ranking-table tr:hover {
                background: rgba(102, 126, 234, 0.1);
            }

            .score-input {
                width: 60px;
                padding: 8px;
                margin: 0 5px;
                border: 2px solid #ddd;
                border-radius: 5px;
                text-align: center;
            }

            .match-result {
                background: rgba(255, 255, 255, 0.9);
                padding: 15px;
                border-radius: 10px;
                margin: 10px 0;
            }

            @media (max-width: 768px) {
                .grid {
                    grid-template-columns: 1fr;
                }

                .auth-section {
                    flex-direction: column;
                    align-items: center;
                }

                .nav-tabs {
                    flex-direction: column;
                }
            }

            @media (max-width: 768px) {
                .container {
                    padding: 10px;
                }

                .header h1 {
                    font-size: 1.8em;
                }

                .auth-section {
                    flex-direction: column;
                    align-items: center;
                    gap: 15px; /* th√™m kho·∫£ng c√°ch gi·ªØa c√°c n√∫t */
                }

                .btn {
                    width: 100%;
                    text-align: center;
                    margin-bottom: 10px; /* th√™m kho·∫£ng c√°ch d∆∞·ªõi m·ªói n√∫t */
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>üè∏ Gi·∫£i ƒê·∫•u C·∫ßu L√¥ng</h1>
                <div class="auth-section">
                    <button class="btn btn-primary" onclick="showLogin()">ƒêƒÉng nh·∫≠p</button>
                    <button class="btn btn-secondary" onclick="showRegister()">ƒêƒÉng k√Ω</button>
                    <button class="btn btn-danger hidden" id="logoutBtn" onclick="logout()">ƒêƒÉng xu·∫•t</button>
                </div>
                <div id="userInfo" class="hidden" style="text-align: center; margin-top: 10px; font-weight: 600;"></div>
            </div>

            <!-- Form ƒëƒÉng nh·∫≠p -->
            <div id="loginForm" class="card hidden">
                <h2>ƒêƒÉng nh·∫≠p</h2>
                <div class="form-group">
                    <label>T√™n ƒëƒÉng nh·∫≠p:</label>
                    <input type="text" id="loginUsername" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p" />
                </div>
                <div class="form-group">
                    <label>M·∫≠t kh·∫©u:</label>
                    <input type="password" id="loginPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" />
                </div>
                <button class="btn btn-primary" onclick="login()">ƒêƒÉng nh·∫≠p</button>
                <button class="btn btn-secondary" onclick="hideAuth()">H·ªßy</button>
            </div>

            <!-- Form ƒëƒÉng k√Ω -->
            <div id="registerForm" class="card hidden">
                <h2>ƒêƒÉng k√Ω th√†nh vi√™n</h2>
                <div class="form-group">
                    <label>T√™n ƒëƒÉng nh·∫≠p:</label>
                    <input type="text" id="playerUsername" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p" />
                </div>
                <div class="form-group">
                    <label>M·∫≠t kh·∫©u:</label>
                    <input type="password" id="playerPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" />
                </div>
                <div class="form-group">
                    <label>Tr√¨nh ƒë·ªô:</label>
                    <select id="playerLevel">
                        <option value="1">Level 1 - M·ªõi b·∫Øt ƒë·∫ßu</option>
                        <option value="2">Level 2 - Trung b√¨nh</option>
                        <option value="3">Level 3 - Cao c·∫•p</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="registerPlayer()">ƒêƒÉng k√Ω</button>
                <button class="btn btn-secondary" onclick="hideAuth()">H·ªßy</button>
            </div>

            <!-- Main content -->
            <div id="mainContent" class="hidden">
                <div class="nav-tabs">
                    <div class="nav-tab active" onclick="showTab('players')">Danh s√°ch th√†nh vi√™n</div>
                    <div class="nav-tab" onclick="showTab('teams')">Danh s√°ch ƒë·ªôi</div>
                    <div class="nav-tab" onclick="showTab('matches')">L·ªãch thi ƒë·∫•u</div>
                    <div class="nav-tab" onclick="showTab('results')">K·∫øt qu·∫£</div>
                    <div class="nav-tab" onclick="showTab('ranking')">B·∫£ng x·∫øp h·∫°ng</div>
                </div>

                <!-- Tab danh s√°ch th√†nh vi√™n -->
                <div id="playersTab" class="tab-content">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2>Danh s√°ch th√†nh vi√™n</h2>
                            <div id="adminControls" class="hidden">
                                <button class="btn btn-primary" onclick="generateTeams()">T·∫°o ƒë·ªôi thi ƒë·∫•u</button>
                                <button class="btn btn-secondary" onclick="clearAllData()">X√≥a d·ªØ li·ªáu</button>
                            </div>
                        </div>
                        <div id="playersList" class="grid"></div>
                    </div>
                </div>

                <!-- Tab danh s√°ch ƒë·ªôi -->
                <div id="teamsTab" class="tab-content hidden">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2>Danh s√°ch ƒë·ªôi thi ƒë·∫•u</h2>
                            <div id="scheduleControls" class="hidden">
                                <button class="btn btn-primary" onclick="generateSchedule()">T·∫°o l·ªãch thi ƒë·∫•u</button>
                            </div>
                        </div>
                        <div id="teamsList" class="grid"></div>
                    </div>
                </div>

                <!-- Tab l·ªãch thi ƒë·∫•u -->
                <div id="matchesTab" class="tab-content hidden">
                    <div class="card">
                        <h2>L·ªãch thi ƒë·∫•u h√¥m nay</h2>
                        <div id="matchesList"></div>
                    </div>
                </div>

                <!-- Tab k·∫øt qu·∫£ -->
                <div id="resultsTab" class="tab-content hidden">
                    <div class="card">
                        <h2>C·∫≠p nh·∫≠t k·∫øt qu·∫£</h2>
                        <div id="resultsForm"></div>
                    </div>
                </div>

                <!-- Tab b·∫£ng x·∫øp h·∫°ng -->
                <div id="rankingTab" class="tab-content hidden">
                    <div class="card">
                        <h2>B·∫£ng x·∫øp h·∫°ng</h2>
                        <table class="ranking-table">
                            <thead>
                                <tr>
                                    <th>H·∫°ng</th>
                                    <th>T√™n nh√≥m</th>
                                    <th>Th√†nh vi√™n</th>
                                    <th>ƒêi·ªÉm</th>
                                    <th>Th·∫Øng</th>
                                    <th>Thua</th>
                                </tr>
                            </thead>
                            <tbody id="rankingBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // D·ªØ li·ªáu to√†n c·ª•c
            let currentUser = null;
            let players = JSON.parse(localStorage.getItem("players") || "[]");
            let teams = JSON.parse(localStorage.getItem("teams") || "[]");
            let matches = JSON.parse(localStorage.getItem("matches") || "[]");
            let results = JSON.parse(localStorage.getItem("results") || "[]");
            let lastMatchTimes = {}; // Theo d√µi th·ªùi gian tr·∫≠n ƒë·∫•u cu·ªëi c·ªßa m·ªói ƒë·ªôi

            // Admin m·∫∑c ƒë·ªãnh
            const adminUser = {
                username: "admin",
                password: "admin123",
                role: "admin",
            };

            // Kh·ªüi t·∫°o
            document.addEventListener("DOMContentLoaded", function () {
                displayPlayers();
                displayMatches();
                displayResults();
                updateRanking();
            });

            // X√°c th·ª±c
            function showLogin() {
                hideAuth();
                document.getElementById("loginForm").classList.remove("hidden");
            }

            function showRegister() {
                hideAuth();
                document.getElementById("registerForm").classList.remove("hidden");
            }

            function hideAuth() {
                document.getElementById("loginForm").classList.add("hidden");
                document.getElementById("registerForm").classList.add("hidden");
            }

            function login() {
                const username = document.getElementById("loginUsername").value;
                const password = document.getElementById("loginPassword").value;

                if (!username || !password) {
                    alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                    return;
                }

                // Ki·ªÉm tra admin
                if (username === adminUser.username && password === adminUser.password) {
                    currentUser = adminUser;
                    showMainContent();
                    return;
                }

                // Ki·ªÉm tra user
                const user = players.find((p) => p.username === username && p.password === password);
                if (user) {
                    currentUser = { ...user, role: "user" };
                    showMainContent();
                } else {
                    alert("T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!");
                }
            }

            function registerPlayer() {
                const username = document.getElementById("playerUsername").value;
                const password = document.getElementById("playerPassword").value;
                const level = parseInt(document.getElementById("playerLevel").value);

                if (!username || !password) {
                    alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                    return;
                }

                if (players.find((p) => p.username === username)) {
                    alert("T√™n ƒëƒÉng nh·∫≠p ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng!");
                    return;
                }

                const player = {
                    id: Date.now(),
                    username,
                    password,
                    level,
                    registeredAt: new Date().toISOString(),
                };

                players.push(player);
                localStorage.setItem("players", JSON.stringify(players));

                alert("ƒêƒÉng k√Ω th√†nh c√¥ng!");
                hideAuth();
                displayPlayers();

                // Reset form
                document.getElementById("playerUsername").value = "";
                document.getElementById("playerPassword").value = "";
            }

            function showMainContent() {
                hideAuth();
                document.getElementById("mainContent").classList.remove("hidden");
                document.getElementById("logoutBtn").classList.remove("hidden");
                document.querySelector(".btn-primary").classList.add("hidden");
                document.querySelector(".btn-secondary").classList.add("hidden");

                const userInfo = document.getElementById("userInfo");
                userInfo.textContent = `Xin ch√†o, ${currentUser.username} (${currentUser.role === "admin" ? "Qu·∫£n tr·ªã vi√™n" : "Th√†nh vi√™n"})`;
                userInfo.classList.remove("hidden");

                if (currentUser.role === "admin") {
                    document.getElementById("adminControls").classList.remove("hidden");
                }
            }

            function logout() {
                currentUser = null;
                document.getElementById("mainContent").classList.add("hidden");
                document.getElementById("logoutBtn").classList.add("hidden");
                document.getElementById("userInfo").classList.add("hidden");
                document.querySelector(".btn-primary").classList.remove("hidden");
                document.querySelector(".btn-secondary").classList.remove("hidden");
                document.getElementById("adminControls").classList.add("hidden");
            }

            // Hi·ªÉn th·ªã danh s√°ch ƒë·ªôi
            function displayTeams() {
                const teamsList = document.getElementById("teamsList");
                teamsList.innerHTML = "";

                if (teams.length === 0) {
                    teamsList.innerHTML = "<p>Ch∆∞a c√≥ ƒë·ªôi n√†o ƒë∆∞·ª£c t·∫°o. Vui l√≤ng t·∫°o ƒë·ªôi thi ƒë·∫•u tr∆∞·ªõc.</p>";
                    return;
                }

                teams.forEach((team) => {
                    const teamCard = document.createElement("div");
                    teamCard.className = "player-card";
                    teamCard.innerHTML = `
                <h3>${team.name}</h3>
                <p>${team.players.map((p) => p.username).join(" & ")}</p>
                <span class="level-badge level-${team.level}">Level ${team.level}</span>
                <p style="margin-top: 10px; font-size: 14px;">
                    Tr·∫≠n ƒë√£ ƒë·∫•u: ${team.wins + team.losses} | ƒêi·ªÉm: ${team.points}
                </p>
            `;
                    teamsList.appendChild(teamCard);
                });

                if (currentUser?.role === "admin" && teams.length >= 2) {
                    document.getElementById("scheduleControls").classList.remove("hidden");
                }
            }

            // Hi·ªÉn th·ªã danh s√°ch th√†nh vi√™n
            function displayPlayers() {
                const playersList = document.getElementById("playersList");
                playersList.innerHTML = "";

                players.forEach((player) => {
                    const playerCard = document.createElement("div");
                    playerCard.className = "player-card";
                    playerCard.innerHTML = `
                    <h3>${player.username}</h3>
                    <span class="level-badge level-${player.level}">Level ${player.level}</span>
                    <p style="margin-top: 10px; font-size: 14px;">
                        ƒêƒÉng k√Ω: ${new Date(player.registeredAt).toLocaleDateString("vi-VN")}
                    </p>
                `;
                    playersList.appendChild(playerCard);
                });
            }

            // T·∫°o l·ªãch thi ƒë·∫•u
            function generateMatches() {
                if (players.length < 2) {
                    alert("C·∫ßn √≠t nh·∫•t 2 th√†nh vi√™n ƒë·ªÉ t·∫°o l·ªãch thi ƒë·∫•u!");
                    return;
                }

                // Chia nh√≥m theo level
                teams = [];
                const levelGroups = { 1: [], 2: [], 3: [] };

                players.forEach((player) => {
                    levelGroups[player.level].push(player);
                });

                // T·∫°o nh√≥m 2 ng∆∞·ªùi cho m·ªói level
                Object.keys(levelGroups).forEach((level) => {
                    const playersInLevel = levelGroups[level];
                    for (let i = 0; i < playersInLevel.length - 1; i += 2) {
                        if (playersInLevel[i + 1]) {
                            teams.push({
                                id: Date.now() + Math.random(),
                                name: `Nh√≥m ${playersInLevel[i].username} & ${playersInLevel[i + 1].username}`,
                                players: [playersInLevel[i], playersInLevel[i + 1]],
                                level: parseInt(level),
                                points: 0,
                                wins: 0,
                                losses: 0,
                            });
                        }
                    }
                });

                // T·∫°o l·ªãch thi ƒë·∫•u
                matches = [];
                for (let i = 0; i < teams.length - 1; i++) {
                    for (let j = i + 1; j < teams.length; j++) {
                        matches.push({
                            id: Date.now() + Math.random(),
                            team1: teams[i],
                            team2: teams[j],
                            date: new Date().toISOString().split("T")[0],
                            status: "scheduled",
                            result: null,
                        });
                    }
                }

                localStorage.setItem("teams", JSON.stringify(teams));
                localStorage.setItem("matches", JSON.stringify(matches));

                alert(`ƒê√£ t·∫°o ${teams.length} nh√≥m v√† ${matches.length} tr·∫≠n ƒë·∫•u!`);
                displayMatches();
                displayResults();
            }

            // Hi·ªÉn th·ªã l·ªãch thi ƒë·∫•u
            function displayMatches() {
                const matchesList = document.getElementById("matchesList");
                matchesList.innerHTML = "";

                if (matches.length === 0) {
                    matchesList.innerHTML = "<p>Ch∆∞a c√≥ l·ªãch thi ƒë·∫•u n√†o. Vui l√≤ng t·∫°o l·ªãch thi ƒë·∫•u.</p>";
                    return;
                }

                matches.forEach((match) => {
                    const matchCard = document.createElement("div");
                    matchCard.className = "match-card";
                    matchCard.innerHTML = `
                    <h3>Tr·∫≠n ƒë·∫•u #${match.id.toString().slice(-4)}</h3>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0;">
                        <div style="text-align: center; flex: 1;">
                            <h4>${match.team1.name}</h4>
                            <span class="level-badge level-${match.team1.level}">Level ${match.team1.level}</span>
                        </div>
                        <div style="padding: 0 20px; font-size: 24px; font-weight: bold;">VS</div>
                        <div style="text-align: center; flex: 1;">
                            <h4>${match.team2.name}</h4>
                            <span class="level-badge level-${match.team2.level}">Level ${match.team2.level}</span>
                        </div>
                    </div>
                    <p><strong>Ng√†y:</strong> ${new Date(match.date).toLocaleDateString("vi-VN")}</p>
                    <p><strong>Tr·∫°ng th√°i:</strong> ${match.status === "scheduled" ? "Ch∆∞a thi ƒë·∫•u" : "ƒê√£ ho√†n th√†nh"}</p>
                    ${match.result ? `<p><strong>K·∫øt qu·∫£:</strong> ${match.result.team1Score} - ${match.result.team2Score}</p>` : ""}
                `;
                    matchesList.appendChild(matchCard);
                });
            }

            // Hi·ªÉn th·ªã form c·∫≠p nh·∫≠t k·∫øt qu·∫£
            function displayResults() {
                const resultsForm = document.getElementById("resultsForm");
                resultsForm.innerHTML = "";

                if (!currentUser || currentUser.role !== "admin") {
                    resultsForm.innerHTML = "<p>Ch·ªâ qu·∫£n tr·ªã vi√™n m·ªõi c√≥ th·ªÉ c·∫≠p nh·∫≠t k·∫øt qu·∫£.</p>";
                    return;
                }

                const pendingMatches = matches.filter((m) => m.status === "scheduled");

                if (pendingMatches.length === 0) {
                    resultsForm.innerHTML = "<p>Kh√¥ng c√≥ tr·∫≠n ƒë·∫•u n√†o c·∫ßn c·∫≠p nh·∫≠t k·∫øt qu·∫£.</p>";
                    return;
                }

                pendingMatches.forEach((match) => {
                    const matchResult = document.createElement("div");
                    matchResult.className = "match-result";
                    matchResult.innerHTML = `
                    <h4>Tr·∫≠n ƒë·∫•u: ${match.team1.name} vs ${match.team2.name}</h4>
                    <div style="display: flex; align-items: center; gap: 10px; margin: 15px 0;">
                        <span>${match.team1.name}</span>
                        <input type="number" class="score-input" id="score1_${match.id}" min="0" max="30" placeholder="0">
                        <span>-</span>
                        <input type="number" class="score-input" id="score2_${match.id}" min="0" max="30" placeholder="0">
                        <span>${match.team2.name}</span>
                        <button class="btn btn-success" onclick="updateResult('${match.id}')">C·∫≠p nh·∫≠t</button>
                    </div>
                `;
                    resultsForm.appendChild(matchResult);
                });
            }

            // C·∫≠p nh·∫≠t k·∫øt qu·∫£ tr·∫≠n ƒë·∫•u
            function updateResult(matchId) {
                const score1 = parseInt(document.getElementById(`score1_${matchId}`).value);
                const score2 = parseInt(document.getElementById(`score2_${matchId}`).value);

                if (isNaN(score1) || isNaN(score2)) {
                    alert("Vui l√≤ng nh·∫≠p ƒëi·ªÉm s·ªë h·ª£p l·ªá!");
                    return;
                }

                const match = matches.find((m) => m.id == matchId);
                if (!match) return;

                match.result = { team1Score: score1, team2Score: score2 };
                match.status = "completed";

                // C·∫≠p nh·∫≠t ƒëi·ªÉm cho c√°c nh√≥m
                const team1 = teams.find((t) => t.id === match.team1.id);
                const team2 = teams.find((t) => t.id === match.team2.id);

                if (score1 > score2) {
                    team1.wins++;
                    team1.points += 3;
                    team2.losses++;
                } else if (score2 > score1) {
                    team2.wins++;
                    team2.points += 3;
                    team1.losses++;
                } else {
                    team1.points += 1;
                    team2.points += 1;
                }

                // L∆∞u k·∫øt qu·∫£
                const result = {
                    id: Date.now(),
                    matchId: match.id,
                    date: new Date().toISOString(),
                    team1: match.team1.name,
                    team2: match.team2.name,
                    score1,
                    score2,
                    winner: score1 > score2 ? match.team1.name : score2 > score1 ? match.team2.name : "H√≤a",
                };

                results.push(result);

                localStorage.setItem("matches", JSON.stringify(matches));
                localStorage.setItem("teams", JSON.stringify(teams));
                localStorage.setItem("results", JSON.stringify(results));

                alert("ƒê√£ c·∫≠p nh·∫≠t k·∫øt qu·∫£ th√†nh c√¥ng!");
                displayMatches();
                displayResults();
                updateRanking();
            }

            // C·∫≠p nh·∫≠t b·∫£ng x·∫øp h·∫°ng
            function updateRanking() {
                const rankingBody = document.getElementById("rankingBody");
                rankingBody.innerHTML = "";

                const sortedTeams = [...teams].sort((a, b) => {
                    if (b.points !== a.points) return b.points - a.points;
                    return b.wins - a.wins;
                });

                sortedTeams.forEach((team, index) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${team.name}</td>
                    <td>${team.players.map((p) => p.username).join(", ")}</td>
                    <td>${team.points}</td>
                    <td>${team.wins}</td>
                    <td>${team.losses}</td>
                `;
                    rankingBody.appendChild(row);
                });
            }

            // Chuy·ªÉn ƒë·ªïi tab
            // C·∫≠p nh·∫≠t h√†m showTab ƒë·ªÉ th√™m tab teams
            function showTab(tabName) {
                document.querySelectorAll(".tab-content").forEach((tab) => tab.classList.add("hidden"));
                document.querySelectorAll(".nav-tab").forEach((tab) => tab.classList.remove("active"));

                document.getElementById(tabName + "Tab").classList.remove("hidden");
                event.target.classList.add("active");

                // C·∫≠p nh·∫≠t n√∫t ƒëi·ªÅu khi·ªÉn admin khi chuy·ªÉn tab
                if (currentUser?.role === "admin") {
                    const showAdminControls = tabName === "players" || tabName === "teams";
                    document.getElementById("adminControls").classList.toggle("hidden", !showAdminControls);

                    const showScheduleControls = tabName === "teams" && teams.length >= 2;
                    document.getElementById("scheduleControls").classList.toggle("hidden", !showScheduleControls);
                }
            }

            // X√≥a t·∫•t c·∫£ d·ªØ li·ªáu (ch·ªâ admin)
            function clearAllData() {
                if (currentUser.role !== "admin") {
                    alert("Ch·ªâ qu·∫£n tr·ªã vi√™n m·ªõi c√≥ th·ªÉ x√≥a d·ªØ li·ªáu!");
                    return;
                }

                if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ d·ªØ li·ªáu? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!")) {
                    players = [];
                    teams = [];
                    matches = [];
                    results = [];

                    localStorage.removeItem("players");
                    localStorage.removeItem("teams");
                    localStorage.removeItem("matches");
                    localStorage.removeItem("results");

                    displayPlayers();
                    displayMatches();
                    displayResults();
                    updateRanking();

                    alert("ƒê√£ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu!");
                }
            }

            // T·∫°o ƒë·ªôi thi ƒë·∫•u
            function generateTeams() {
                if (players.length < 2) {
                    alert("C·∫ßn √≠t nh·∫•t 2 th√†nh vi√™n ƒë·ªÉ t·∫°o ƒë·ªôi thi ƒë·∫•u!");
                    return;
                }

                teams = [];
                const levelGroups = { 1: [], 2: [], 3: [] };

                // X√°o tr·ªôn ng·∫´u nhi√™n danh s√°ch ng∆∞·ªùi ch∆°i
                const shuffledPlayers = [...players].sort(() => Math.random() - 0.5);

                shuffledPlayers.forEach((player) => {
                    levelGroups[player.level].push(player);
                });

                // T·∫°o ƒë·ªôi 2 ng∆∞·ªùi cho m·ªói level
                Object.keys(levelGroups).forEach((level) => {
                    const playersInLevel = levelGroups[level];
                    for (let i = 0; i < playersInLevel.length - 1; i += 2) {
                        if (playersInLevel[i + 1]) {
                            teams.push({
                                id: Date.now() + Math.random(),
                                name: `ƒê·ªôi ${playersInLevel[i].username} & ${playersInLevel[i + 1].username}`,
                                players: [playersInLevel[i], playersInLevel[i + 1]],
                                level: parseInt(level),
                                points: 0,
                                wins: 0,
                                losses: 0,
                                lastMatchTime: 0, // Th·ªùi gian tr·∫≠n ƒë·∫•u cu·ªëi c√πng
                            });
                        }
                    }
                });

                localStorage.setItem("teams", JSON.stringify(teams));
                alert(`ƒê√£ t·∫°o ${teams.length} ƒë·ªôi thi ƒë·∫•u!`);
                displayTeams();
                showTab("teams"); // Chuy·ªÉn sang tab ƒë·ªôi
            }

            // T·∫°o l·ªãch thi ƒë·∫•u v·ªõi thu·∫≠t to√°n tr√°nh c√°c ƒë·ªôi ƒë·∫•u li√™n ti·∫øp
            function generateSchedule() {
                if (teams.length < 2) {
                    alert("C·∫ßn √≠t nh·∫•t 2 ƒë·ªôi ƒë·ªÉ t·∫°o l·ªãch thi ƒë·∫•u!");
                    return;
                }

                matches = [];
                lastMatchTimes = {};

                // Kh·ªüi t·∫°o th·ªùi gian tr·∫≠n ƒë·∫•u cu·ªëi cho m·ªói ƒë·ªôi
                teams.forEach((team) => {
                    lastMatchTimes[team.id] = 0;
                });

                // T·∫°o danh s√°ch c√°c c·∫∑p ƒë·∫•u c√≥ th·ªÉ
                const possibleMatches = [];
                for (let i = 0; i < teams.length - 1; i++) {
                    for (let j = i + 1; j < teams.length; j++) {
                        possibleMatches.push({
                            team1: teams[i],
                            team2: teams[j],
                            priority: 0, // ∆Øu ti√™n ban ƒë·∫ßu
                        });
                    }
                }

                // S·∫Øp x·∫øp c√°c tr·∫≠n ƒë·∫•u ng·∫´u nhi√™n
                possibleMatches.sort(() => Math.random() - 0.5);

                // T·∫°o l·ªãch thi ƒë·∫•u
                let currentTime = 1;
                const scheduledMatches = [];
                const matchCount = Math.min(possibleMatches.length, teams.length * 2); // Gi·ªõi h·∫°n s·ªë tr·∫≠n

                while (scheduledMatches.length < matchCount && possibleMatches.length > 0) {
                    // T√≠nh to√°n ƒë·ªô ∆∞u ti√™n d·ª±a tr√™n th·ªùi gian ngh·ªâ c·ªßa c√°c ƒë·ªôi
                    possibleMatches.forEach((match) => {
                        const timeSinceTeam1 = currentTime - lastMatchTimes[match.team1.id];
                        const timeSinceTeam2 = currentTime - lastMatchTimes[match.team2.id];
                        match.priority = Math.min(timeSinceTeam1, timeSinceTeam2);
                    });

                    // S·∫Øp x·∫øp theo ƒë·ªô ∆∞u ti√™n gi·∫£m d·∫ßn
                    possibleMatches.sort((a, b) => b.priority - a.priority);

                    // Ch·ªçn tr·∫≠n c√≥ ƒë·ªô ∆∞u ti√™n cao nh·∫•t
                    const nextMatch = possibleMatches.shift();

                    // Th√™m tr·∫≠n ƒë·∫•u v√†o l·ªãch
                    scheduledMatches.push({
                        id: Date.now() + Math.random(),
                        team1: nextMatch.team1,
                        team2: nextMatch.team2,
                        date: new Date().toISOString().split("T")[0],
                        timeSlot: currentTime,
                        status: "scheduled",
                        result: null,
                    });

                    // C·∫≠p nh·∫≠t th·ªùi gian tr·∫≠n ƒë·∫•u cu·ªëi c·ªßa c√°c ƒë·ªôi
                    lastMatchTimes[nextMatch.team1.id] = currentTime;
                    lastMatchTimes[nextMatch.team2.id] = currentTime;

                    // TƒÉng th·ªùi gian cho tr·∫≠n ti·∫øp theo
                    currentTime++;
                }

                matches = scheduledMatches;
                localStorage.setItem("matches", JSON.stringify(matches));
                alert(`ƒê√£ t·∫°o ${matches.length} tr·∫≠n ƒë·∫•u! C√°c ƒë·ªôi kh√¥ng ph·∫£i ƒë·∫•u li√™n ti·∫øp.`);
                displayMatches();
                showTab("matches"); // Chuy·ªÉn sang tab l·ªãch ƒë·∫•u
            }

        </script>
    </body>
</html>
